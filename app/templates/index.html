{% extends 'base.html' %}

{% block title %}Sensotura{% endblock %}

{% block main %}


<div class="generalIndicators">

    <h2>–¢–µ–∫—É—â–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
    <div class="fridges">
        {% for fridge in fridges %}
        <div class="fridge">
            <div class="fridge_pic">
                {% if fridge.last_temp <= -35 %} <img src="{{ url_for('static', filename='img/greenTemp.png') }}">
                    {% elif -35 < fridge.last_temp <=-30 %} <img
                        src="{{ url_for('static', filename='img/orangeTemp.png') }}">
                        {% elif fridge.last_temp > -30 %}
                        <img src="{{ url_for('static', filename='img/redTemp.png') }}">
                        {% endif %}
            </div>
            <div class="fridge_info">
                <h3>{{ fridge.name }}</h3>
                {% if fridge.last_temp <= -35 %} <p class="fridge_temp" style="color: #1b922f">{{ fridge.last_temp }} ¬∞C
                    <span class="blink">&#11044;</span></p>
                    {% elif -35 < fridge.last_temp <=-30 %} <p class="fridge_temp" style="color: #f59e0b">{{
                        fridge.last_temp }} ¬∞C <span class="blink">&#11044;</span></p>
                        {% elif fridge.last_temp > -30 %}
                        <p class="fridge_temp" style="color: #ef4444">{{ fridge.last_temp }} ¬∞C <span
                                class="blink">&#11044;</span></p>
                        {% endif %}
                        <p class="fridge_temp_lst_updt">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ fridge.last_time }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    <h2>–ì—Ä–∞—Ñ–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 —á–∞—Å–æ–≤</h2>
    <div class="chartContainer">
        <canvas class="tempChart" id="tempChart"></canvas>
    </div>
</div>

<script>
    const labels = {{ labels | tojson }};
    const datasets = {{ datasets | tojson }};

    console.log('Chart labels:', labels);
    console.log('Chart datasets:', datasets);

    // üîÅ –ü–ª–∞–≥–∏–Ω: –º–∏–≥–∞—é—â–∞—è –ø–æ—Å–ª–µ–¥–Ω—è—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–π –ª–∏–Ω–∏–∏
    const blinkPlugin = {
        id: 'blinkLastPoints',
        afterDatasetDraw(chart, args) {
            const { ctx } = chart;
            const datasetIndex = args.index;
            const meta = chart.getDatasetMeta(datasetIndex);
            const dataset = chart.data.datasets[datasetIndex];

            if (!meta.visible) return;

            // –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ-null —Ç–æ—á–∫—É
            let lastIndex = -1;
            for (let i = dataset.data.length - 1; i >= 0; i--) {
                if (dataset.data[i] !== null && dataset.data[i] !== undefined) {
                    lastIndex = i;
                    break;
                }
            }

            if (lastIndex === -1 || !meta.data[lastIndex]) return;

            const point = meta.data[lastIndex];
            const now = Date.now();
            const pulse = Math.abs(Math.sin(now / 300));
            const radius = 5 + 2 * pulse;

            ctx.save();
            ctx.beginPath();
            ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI);
            ctx.fillStyle = dataset.borderColor;
            ctx.globalAlpha = 0.6 + 0.4 * pulse;
            ctx.fill();
            ctx.restore();
        }
    };

    const ctx = document.getElementById('tempChart').getContext('2d');

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            spanGaps: false,
            maintainAspectRatio: false,
            scales: {
                x: {
                    border: { display: false },
                    grid: { display: false, drawBorder: false },
                    ticks: {
                        padding: 10  // –æ—Ç—Å—Ç—É–ø –º–µ—Ç–æ–∫ —Å–Ω–∏–∑—É
                    }
                },
                y: {
                    border: { display: false },
                    grid: {
                        display: true,
                        drawBorder: false,
                        color: '#e5e7eb'
                    },
                    ticks: {
                        drawTicks: false
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'line',
                        font: {
                            family: 'Inter'
                        }
                    }
                }
            },
            animation: false  // –æ—Ç–∫–ª—é—á–∞–µ–º –æ–±—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é, —Ç–æ–ª—å–∫–æ –º–∏–≥–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
        },
        plugins: [blinkPlugin]
    });

    // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∂–¥—ã–µ 100 –º—Å –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –º–∏–≥–∞–Ω–∏—è
    setInterval(() => chart.update('none'), 100);
</script>



{% endblock %}