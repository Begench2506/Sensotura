{% extends 'base.html' %}

{% block title %}Sensotura{% endblock %}

{% block main %}


<div class="generalIndicators">

    <h2>Текущая температура устройств</h2>
    <div class="fridges">
        {% for fridge in fridges %}
        <div class="fridge">
            <div class="fridge_pic">
                {% if fridge.last_temp <= -35 %} <img src="{{ url_for('static', filename='img/greenTemp.png') }}">
                    {% elif -35 < fridge.last_temp <=-30 %} <img
                        src="{{ url_for('static', filename='img/orangeTemp.png') }}">
                        {% elif fridge.last_temp > -30 %}
                        <img src="{{ url_for('static', filename='img/redTemp.png') }}">
                        {% endif %}
            </div>
            <div class="fridge_info">
                <h3>{{ fridge.name }}</h3>
                {% if fridge.last_temp <= -35 %} <p class="fridge_temp" style="color: #1b922f">{{ fridge.last_temp }} °C
                    <span class="blink">&#11044;</span></p>
                    {% elif -35 < fridge.last_temp <=-30 %} <p class="fridge_temp" style="color: #f59e0b">{{
                        fridge.last_temp }} °C <span class="blink">&#11044;</span></p>
                        {% elif fridge.last_temp > -30 %}
                        <p class="fridge_temp" style="color: #ef4444">{{ fridge.last_temp }} °C <span
                                class="blink">&#11044;</span></p>
                        {% endif %}
                        <p class="fridge_temp_lst_updt">Обновлено: {{ fridge.last_time }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="graph">
        <h2>График температуры устройств за последние 12 часов</h2>
        <div class="chartContainer">
            <canvas class="tempChart" id="tempChart"></canvas>
        </div>
    </div>
</div>

<script>
  const labels = {{ labels | tojson }};
  const datasets = {{ datasets | tojson }};

  // Плагин мигания последней фактической точки
  const blinkPlugin = {
    id: 'blinkLastPoints',
    afterDatasetDraw(chart, args) {
      const { ctx } = chart;
      const datasetIndex = args.index;
      const meta = chart.getDatasetMeta(datasetIndex);
      const dataset = chart.data.datasets[datasetIndex];
      if (!meta.visible) return;

      // ищем последнюю не-null точку
      let lastIndex = -1;
      for (let i = dataset.data.length - 1; i >= 0; i--) {
        if (dataset.data[i] !== null && dataset.data[i] !== undefined) {
          lastIndex = i;
          break;
        }
      }
      if (lastIndex === -1 || !meta.data[lastIndex]) return;

      const point = meta.data[lastIndex];
      const now = Date.now();
      const pulse = Math.abs(Math.sin(now / 300));
      const radius = 5 + 2 * pulse;

      ctx.save();
      ctx.beginPath();
      ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI);
      ctx.fillStyle = dataset.borderColor;
      ctx.globalAlpha = 0.6 + 0.4 * pulse;
      ctx.fill();
      ctx.restore();
    }
  };

  // Вариант B: точный «зазор» снизу легенды (кастомным плагином)
  const legendGapPlugin = {
    id: 'legendGap',
    beforeInit(chart) {
      const originalFit = chart.legend && chart.legend.fit;
      if (!originalFit) return;
      chart.legend.fit = function () {
        originalFit.bind(this)();
        // увеличиваем высоту легенды на N пикселей => отступ между легендой и графиком
        this.height += 12; // настройте значение (например, 8–20)
      };
    }
  };

  const ctx = document.getElementById('tempChart').getContext('2d');

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      spanGaps: false,
      maintainAspectRatio: false,

      // Вариант A: общий отступ между легендой (сверху) и графиком
      // Можно увеличить/уменьшить top, либо удалить блок, если используете плагин legendGapPlugin
      layout: {
        padding: {
          top: 0,   // основной отступ между легендой (position: 'top') и областью графика
          right: 0,
          bottom: 0,
          left: 0
        }
      },

      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: true,
            pointStyle: 'line',
            padding: 10,           // «воздух» внутри самой легенды
            font: { family: 'Inter' }
          }
        }
      },

      scales: {
        x: {
          border: { display: false },
          grid: {
            display: false,
            drawBorder: false,
            color: '#b9b9b9'
          },
          ticks: {
            padding: 10 // отступ меток
          }
        },
        y: {
          border: { display: false },
          grid: {
            display: true,
            drawBorder: false,
            color: '#b9b9b9'
          },
          ticks: {
            drawTicks: false
          }
        }
      },

      animation: false // отключаем общую анимацию, мигание вручную
    },

    // Подключаем оба плагина. Если хватит одного из способов — удалите ненужный.
    plugins: [legendGapPlugin, blinkPlugin]
  });

  // Обновление для эффекта мигания
  setInterval(() => chart.update('none'), 100);
</script>




{% endblock %}